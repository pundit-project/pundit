#!/usr/bin/perl
#
# Copyright 2012 Georgia Institute of Technology
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

use strict;

#use Data::Dumper;

=pod

=head1 DESCRIPTION

This script reads the events from the database and processes it into a data structure that the loc_processor can use.

=cut

# dummy traceroute start
#my @tr_list = (
#	{
#		'src' => 'A1',
#		'tr_list' => 
#			[
#				{
#					'ts' => time,
#					'path' => ['A1',],	
#				},
#				{
#					'ts' => time,
#					'path' => ['E1', 'F3', 'B1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['E1', 'C1'],
#				},
#				{
#					'ts' => time,
#					'path' => ['E1', 'F3', 'D1',],
#				},
#			],
#	},
#	{
#		'src' => 'B1',
#		'tr_list' => 
#			[
#				{
#					'ts' => time,
#					'path' => ['F1', 'E3', 'A1'],
#				},
#				{
#					'ts' => time,
#					'path' => ['B1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['F1', 'E3', 'C1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['F1', 'D1',],
#				},
#			],
#	},
#	{
#		'src' => 'C1',
#		'tr_list' => 
#			[ 
#				{
#					'ts' => time,
#					'path' => ['E2', 'A1'],
#				},
#				{
#					'ts' => time,
#					'path' => ['E2', 'F3', 'B1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['C1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['E2', 'F3', 'D1',],
#				},
#			],
#	},
#	{
#		'src' => 'D1',
#		'tr_list' => 
#			[ 
#				{
#					'ts' => time,
#					'path' => ['F2', 'E3', 'A1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['F2', 'B1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['F2', 'E3', 'C1',],
#				},
#				{
#					'ts' => time,
#					'path' => ['D1',],
#				},
#			],
#	},
#);
# dummy traceroute end

my @tr_list = (
	{
		'src' => "gammon.barrow.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.barrow.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "131.144.101.25", "131.144.101.2", "198.72.75.14", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu", ],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.29", "65.112.44.65", "67.14.14.138", "192.205.37.165", "12.122.141.190", "12.122.117.25", "12.94.104.14", "gammon.jasper.k12.ga.us", ],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.141.234", "12.122.117.25", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.29", "65.112.44.65", "67.14.14.134", "192.205.37.165", "12.122.140.246", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.117.122", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.117.122", "12.122.31.30", "12.122.106.9", "74.175.192.213", "12.81.28.12", "12.83.23.183", "12.81.105.46", "65.83.239.122", "12.83.2.200", "12.81.16.9", "12.83.2.102", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.117.122", "12.122.140.169", "74.175.192.101", "12.81.0.58", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.117.122", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.29", "65.112.44.65", "67.14.14.138", "192.205.37.165", "12.122.141.190", "12.123.22.110", "12.122.141.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.117.122", "12.122.140.169", "74.175.192.97", "12.81.0.56", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				{
					'ts' => time,
					'path' => ["168.24.25.1", "168.24.1.97", "131.144.206.25", "204.2.241.33", "129.250.5.189", "192.205.36.157", "12.122.141.234", "12.122.117.25", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.jasper.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.jasper.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.31.30", "12.122.106.9", "74.175.192.13", "12.81.28.12", "12.81.105.53", "12.81.105.46", "65.83.239.122", "12.83.2.200", "12.81.16.9", "12.83.2.113", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "74.175.192.105", "12.81.0.52", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.122.117.26", "12.123.22.110", "12.122.141.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "74.175.192.109", "12.81.0.6", "12.81.0.29", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.128.1", "12.94.104.13", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.putnam.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.putnam.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.31.30", "12.122.106.9", "74.175.192.13", "12.81.28.12", "12.81.104.189", "65.83.237.10", "65.83.239.122", "12.83.2.202", "12.81.16.9", "12.83.2.102", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "74.175.192.109", "12.81.0.56", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.122.117.26", "12.123.22.110", "12.122.141.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "74.175.192.101", "12.81.0.58", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.228.1", "12.94.104.89", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.ware.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.ware.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.158", "12.122.1.46", "12.122.155.169", "192.205.35.102", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.158", "12.122.1.46", "12.122.155.169", "192.205.35.102", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.140.169", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.140.169", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.158", "12.122.106.69", "74.175.192.9", "12.81.28.16", "12.83.23.181", "12.81.104.162", "65.83.239.122", "12.83.2.202", "12.81.16.9", "12.81.104.18", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.140.169", "74.175.192.109", "12.81.0.6", "12.81.0.29", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.140.169", "74.175.192.97", "12.81.0.12", "12.81.0.29", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.51.1", "12.124.82.153", "12.123.34.30", "12.122.31.29", "12.122.140.169", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.dawson.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.dawson.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.31.30", "12.122.106.9", "74.175.192.205", "12.81.28.18", "12.83.23.181", "12.81.105.44", "65.83.239.166", "12.83.2.202", "12.81.16.9", "12.83.2.117", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.169", "74.175.192.105", "12.81.0.6", "12.81.0.29", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.169", "74.175.192.109", "12.81.0.14", "12.81.0.29", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.48.1", "12.90.208.105", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.rabun.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.rabun.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.59", "74.175.192.98", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.32", "12.81.0.7", "74.175.192.102", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.53", "74.175.192.106", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.55", "74.175.192.110", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.32", "12.81.0.17", "74.175.192.106", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.59", "74.175.192.110", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.32", "12.81.0.7", "74.175.192.106", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.80", "12.81.0.57", "74.175.192.102", "12.122.117.26", "12.123.22.110", "12.122.141.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.32", "12.81.0.29", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.80.1", "65.14.243.185", "12.81.0.32", "12.81.0.15", "74.175.192.98", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.white.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.white.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.76", "12.81.0.53", "74.175.192.110", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.28", "12.81.0.7", "74.175.192.110", "12.122.140.170", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.76", "12.81.0.55", "74.175.192.106", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.76", "12.81.0.57", "74.175.192.102", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.76", "12.81.0.55", "74.175.192.106", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.28", "12.81.0.17", "74.175.192.106", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.28", "12.81.0.33", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.28", "12.81.0.13", "74.175.192.102", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.28", "12.81.0.13", "74.175.192.98", "12.122.117.26", "12.123.22.110", "12.122.141.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.76.1", "65.14.129.197", "12.81.0.76", "12.81.0.57", "74.175.192.110", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.franklin.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.franklin.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.245", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.245", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.31.30", "12.122.106.9", "74.175.192.205", "12.81.28.18", "12.83.23.181", "12.81.104.162", "65.83.239.166", "12.83.2.200", "12.81.16.9", "12.83.2.102", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.169", "74.175.192.109", "12.81.0.14", "12.81.0.29", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.169", "74.175.192.101", "12.81.0.52", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.27.1", "12.249.44.213", "12.122.117.86", "12.122.1.221", "12.122.140.169", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.stewart.k12.ga.us",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.stewart.k12.ga.us",],
				},
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.141.58", "12.123.22.109", "12.122.141.189", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.141.58", "12.123.22.109", "12.122.141.189", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.141.58", "12.123.22.109", "12.122.117.25", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.141.58", "12.123.22.109", "12.122.117.25", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.31.30", "12.122.106.9", "74.175.192.213", "12.81.28.14", "12.81.104.75", "12.81.105.44", "65.83.239.122", "12.83.2.200", "12.81.16.9", "12.83.2.117", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.140.169", "74.175.192.109", "12.81.0.58", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.140.169", "74.175.192.97", "12.81.0.58", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["168.11.230.1", "12.86.16.93", "12.122.140.58", "12.123.22.249", "12.122.140.169", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.gilmerschools.com",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.gilmerschools.com",],
				},
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.59", "74.175.192.110", "12.122.117.26", "12.122.141.189", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.53", "74.175.192.98", "12.122.117.26", "12.122.141.189", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.59", "74.175.192.98", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.55", "74.175.192.106", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.28", "12.81.0.17", "74.175.192.110", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.59", "74.175.192.106", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.28", "12.81.0.7", "74.175.192.102", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.76", "12.81.0.53", "74.175.192.106", "12.122.140.170", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.8.144.1", "68.152.136.193", "12.81.0.28", "12.81.0.15", "74.175.192.110", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
	{
		'src' => "gammon.cowetaschools.org",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["gammon.cowetaschools.org",],
				},
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.117.26", "12.122.141.189", "192.205.37.166", "65.114.55.138", "130.207.254.187", "130.207.254.30", "perfsonar.rnoc.gatech.edu",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.117.26", "12.122.141.189", "192.205.37.166", "65.112.44.66", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.140.170", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.140.170", "12.122.31.30", "12.122.106.9", "74.175.192.213", "12.81.28.12", "12.83.23.183", "65.83.237.10", "65.83.239.122", "12.83.2.202", "12.81.16.9", "12.83.2.106", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "74.175.192.97", "12.81.0.56", "12.81.0.77", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.140.170", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "12.122.140.170", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["168.9.128.1", "12.94.104.169", "74.175.192.105", "12.81.0.54", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
			],
	},
	{
		'src' => "perfsonar.rnoc.gatech.edu",
		'tr_list' => 
			[ 
				{
					'ts' => time,
					'path' => ["perfsonar.rnoc.gatech.edu",],
				},
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "198.72.75.13", "131.144.101.30", "131.144.206.30", "168.24.1.100", "gammon.barrow.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.145", "154.54.81.25", "154.54.83.210", "192.205.36.237", "12.122.141.190", "12.122.117.25", "12.94.104.14", "gammon.jasper.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.145", "154.54.81.25", "154.54.3.146", "192.205.36.237", "12.122.141.190", "12.122.117.25", "12.94.104.90", "gammon.putnam.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.149", "154.54.81.33", "154.54.83.206", "154.54.10.70", "12.122.140.246", "12.122.31.30", "12.123.34.29", "12.124.82.154", "gammon.ware.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.149", "154.54.81.33", "154.54.83.206", "192.205.36.237", "12.122.140.246", "12.122.1.222", "12.122.117.85", "12.90.208.106", "gammon.dawson.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.149", "154.54.81.33", "154.54.40.250", "192.205.36.237", "12.122.140.246", "12.122.31.30", "12.122.106.9", "74.175.192.205", "12.81.28.12", "12.81.105.49", "65.83.237.10", "65.83.239.122", "12.83.2.202", "12.81.16.9", "12.83.2.117", "12.81.0.81", "65.14.243.186", "gammon.rabun.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "65.114.55.137", "67.14.14.138", "192.205.37.165", "12.122.141.190", "12.122.117.25", "74.175.192.97", "12.81.0.6", "12.81.0.29", "65.14.129.198", "gammon.white.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.145", "154.54.81.25", "154.54.83.210", "192.205.36.237", "12.122.140.246", "12.122.1.222", "12.122.117.85", "12.249.44.214", "gammon.franklin.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "65.114.55.137", "67.14.14.134", "192.205.37.165", "12.122.140.246", "12.123.22.250", "12.122.140.57", "12.86.16.94", "gammon.stewart.k12.ga.us",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.149", "154.54.81.33", "154.54.83.206", "154.54.13.42", "12.122.140.246", "12.122.140.169", "74.175.192.97", "12.81.0.54", "12.81.0.77", "68.152.136.194", "gammon.gilmerschools.com",],
				},
				
				{
					'ts' => time,
					'path' => ["143.215.250.97", "130.207.254.29", "130.207.254.185", "38.101.220.161", "38.20.35.149", "154.54.81.33", "154.54.83.206", "154.54.10.70", "12.122.141.190", "12.122.117.25", "12.94.104.170", "gammon.cowetaschools.org",],
				},
			],
	},
);

# Returns the matrix built from traceroutes
# Parameters: 
# $in_first_tr_ts - timestamp of the first traceroute to get. Leave as 0 if you want all
# $in_last_tr_ts - timestamp of the last traceroute to get. Leave as 0 if you want all
# Returns an array containing:
# $out_first_tr_ts - timestamp of the returned first traceroute
# $out_last_tr_ts - timestamp of the returned last traceroute
# $out_tr_matrix - Hash of Hashes pointing to arrays of traceroutes. Simulates adjacency list
# $out_node_list - Hash of Nodes to Src/Dst pairs. This is to faciliate reverse lookup from a node to path
sub get_tr_matrix
{
	# Get the range from the function call
	my ($in_first_tr_ts, $in_last_tr_ts) = @_;
	
	# Build the structs from the traceroutes
	my ($out_first_tr_ts, $out_last_tr_ts, $out_tr_matrix, $out_node_list) = process_tr_all(\@tr_list);
	
	return ($out_first_tr_ts, $out_last_tr_ts, $out_tr_matrix, $out_node_list);
}

# Builds tr matrix from entire tr list
# Calls process_tr_host
# Params:
# $in_tr_tree - Array of hashes containing mapping of src address and traceroute list for that host
# Returns:
# $out_tr_matrix - Hash of traceroute paths {src}{dest}
# $out_node_list - Hash of node to src/dst pairs. For reverse lookup
sub process_tr_all
{
	my ($in_tr_tree) = @_;
	
	# init the new hashes
	my %out_tr_matrix = ();
	my %out_node_list = ();
	my $first_ts;
	my $last_ts;
	
	foreach (@$in_tr_tree)
	{
		my ($first_tr_ts, $last_tr_ts) = process_tr_host($_->{'src'}, $_->{'tr_list'}, \%out_tr_matrix, \%out_node_list);
		
		# Skip if undefined
		next if (!$first_tr_ts || !$last_tr_ts);
		$first_ts = $first_tr_ts if (!$first_ts || ($first_ts > $first_tr_ts));
		$last_ts = $last_tr_ts if (!$last_ts || ($last_ts < $last_tr_ts));
	}
	return ($first_ts, $last_ts, \%out_tr_matrix, \%out_node_list);
}

# Builds tr matrix from all tr entries for a single host
# Calls process_tr_entry
# Params
# $in_tr_src - Source address. 
# $in_tr_list - Traceroute info. Array of arrays that hold the addresses
# $in_out_tr_matrix - Hash of traceroute paths. May be partially filled
# $in_out_node_list - Hash of Node to Src/Dst pairs. For Reverse lookup later. May be partially-filled 
# Returns
# ($first_ts, $last_ts) - Pair of timestamps of the first/last traceroute
sub process_tr_host
{
	my ($in_tr_src, $in_tr_list, $in_out_tr_matrix, $in_out_node_list) = @_;
	my $first_ts;
	my $last_ts;
	
	# Process each traceroute path using the helper function
	foreach (@$in_tr_list)
	{
		#print "calling process with src $in_tr_src and dst $_->{'path'}[-1]\n";
		my $ts = process_tr_entry($in_tr_src, $_, $in_out_tr_matrix, $in_out_node_list);
		
		# Skip to the next entry if TS not valid
		next if (!$ts);
		
		# Update the timestamps
		$first_ts = $ts if ((!$first_ts) || ($ts < $first_ts));
		$last_ts = $ts if ((!$last_ts) || ($ts > $last_ts));	
	}
	return ($first_ts, $last_ts);
}

# Build tr matrix from a traceroute entry
# Param
# $in_tr_src - Source address
# $in_tr_entry - The traceroute. An array of addresses
# $in_out_tr_matrix - Hash of traceroute paths. May be partially filled
# $in_out_node_list - Hash of Node to Src/Dst pairs. For Reverse lookup later. May be partially-filled
# Returns
# The timestamp of the traceroute, or undef if skipped
sub process_tr_entry
{
	my ($in_tr_src, $in_tr_entry, $in_out_tr_matrix, $in_out_node_list) = @_;
	my $new_tr_entry = $in_tr_entry->{'path'};
	
	#print Dumper $new_tr_entry;
	
	# skip self traces
	if ($in_tr_src eq $$new_tr_entry[0])
	{
		return undef;
	}
	
	# Add to the tr matrix
	$in_out_tr_matrix->{$in_tr_src}->{$$new_tr_entry[-1]} = $new_tr_entry;
	
	# Add the source node to the node list
	if (!exists($in_out_node_list->{$in_tr_src}))
	{
		my @new_array = ();
		$in_out_node_list->{$in_tr_src} = \@new_array;
	}
=pod
	my @new_entry = ($in_tr_src, $new_tr_entry[-1]);
	say "Src: $in_tr_src adding";
	print Dumper \@new_entry;
	push ($in_out_node_list->{$in_tr_src}, \@new_entry);
=cut	
	# Add the path nodes to the node list
	foreach (@$new_tr_entry)
	{
		my @new_entry = ($in_tr_src, $$new_tr_entry[-1]);
		#print "Adding $_ with $in_tr_src $$new_tr_entry[-1] \n";
		if (!exists($in_out_node_list->{$_}))
		{
			my @new_array = ();
			$in_out_node_list->{$_} = \@new_array;
		}

		# We assume we don't have repeats, otherwise check here before pushing
		push(@{$in_out_node_list->{$_}}, \@new_entry);
	}
	return $in_tr_entry->{'ts'};
}

sub build_node_idx
{
	my ($in_tr_list) = @_;
	
	my %node_list = ();
	my %edge_list = ();
	my @path_list = ();
	my $node_count = 0;
	
	foreach my $entry (@$in_tr_list)
	{
		my $tr_list = $entry->{'tr_list'};
		my $src_str = $entry->{'src'};
		
		# Do mapping to src_id
		if (!exists($node_list{$src_str}))
		{
			$node_list{$src_str} = $node_count++;
		}
		my $src_id = $node_list{$src_str};
				
		foreach my $tr_entry (@$tr_list)
		{
			my $i;
			my $path = $tr_entry->{'path'};
			
			my $count = scalar(@$path);
						
			for ($i = 0; $i < $count; $i++)
			{
				my $node_str = $$path[$i];
				if (!exists($node_list{$node_str}))
				{
					$node_list{$node_str} = $node_count++;
				}
			}
		}
	}
	
	return \%node_list;
}

sub get_tr_list
{
	return \@tr_list;
}
=pod
CREATE TABLE loc_graph_nodes
(
	host varchar(255) NOT NULL,
	id int,
	PRIMARY KEY (id)
);

CREATE TABLE loc_graph_edges
(
	src_id int,
	dst_id int
);

CREATE TABLE loc_graph_paths
(
	node_id int,
	src_id int,
	dst_id int
);
=cut
=pod
# Test Code
my ($out_first_tr_ts, $out_last_tr_ts, $x) = get_tr_matrix(0, 0);
say $out_first_tr_ts . " to " . $out_last_tr_ts;
print Dumper ($x);
=cut
=pod
my ($first, $last, $x, $y) = process_tr_all(\@tr_list);
print "First is $first, Last is $last\n";
print "x is ";
print Dumper ($x);
print "y is ";
print Dumper ($y);
=cut
